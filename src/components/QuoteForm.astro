---
// src/components/QuoteForm.astro
// This component is now fully self-contained, with all HTML and JavaScript logic encapsulated.
---
<section id="quote" class="py-20 md:py-28 bg-gradient-to-br from-light-sky to-sky-200">
 <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
     <div id="form-area">
         <div class="p-6 md:p-8">
            <h2 class="text-3xl md:text-4xl font-extrabold text-deep-navy text-center mb-4">Get Your Guaranteed Quote</h2>
            <p class="text-center text-gray-600 mb-8">Fill in the details below for a transparent, no-surprise price.</p>
            <div class="progress-bar mb-2"><div class="progress-fill" id="progress" style="width: 0%;"></div></div>
            <div class="text-sm text-slate-500 text-right">Step <span id="current-step-display">1</span> of 4</div>
         </div>
         <div class="step-indicator px-8 py-4">
            <div class="step active" data-step="1"><div class="step-number">1</div><div class="step-label">Property</div></div>
            <div class="step" data-step="2"><div class="step-number">2</div><div class="step-label">Add-ons</div></div>
            <div class="step" data-step="3"><div class="step-number">3</div><div class="step-label">Your Info</div></div>
            <div class="step" data-step="4"><div class="step-number">4</div><div class="step-label">Review</div></div>
         </div>
         <div class="px-6 md:px-8 pb-8">
             <form id="quote-form" name="quote-request" method="POST" data-netlify="true" netlify-honeypot="bot-field">
                 <p class="hidden"><label>Don’t fill this out if you’re human: <input name="bot-field" /></label></p>
                 
                 <div class="form-step active" id="step-1">
                    <h3 class="text-2xl font-bold text-deep-navy mb-6">About Your Property</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-slate-700 font-medium mb-2" for="property-type">Property Type</label>
                            <select id="property-type" name="property-type" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-fresh-sky" required aria-describedby="property-type-error-msg"><option value="">Select...</option><option value="House">House</option><option value="Apartment">Apartment</option><option value="Townhouse">Townhouse</option></select>
                            <p id="property-type-error-msg" class="error-message">Please select a property type.</p>
                        </div>
                        <div>
                            <label class="block text-slate-700 font-medium mb-2" for="bedrooms">Bedrooms</label>
                            <select id="bedrooms" name="bedrooms" class="w-full p-3 border border-slate-300 rounded-lg"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-slate-700 font-medium mb-2" for="bathrooms">Bathrooms</label>
                            <select id="bathrooms" name="bathrooms" class="w-full p-3 border border-slate-300 rounded-lg"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select>
                        </div>
                    </div>
                    <div class="flex justify-end mt-8"><button type="button" class="next-step bg-fresh-sky hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg">Next <i class="fas fa-arrow-right ml-2"></i></button></div>
                 </div>

                 <div class="form-step" id="step-2">
                    <h3 class="text-2xl font-bold text-deep-navy mb-6">Customise Your Clean</h3>
                    <div class="space-y-4">
                        <label class="form-checkbox-label flex items-center p-4 border border-gray-300 rounded-lg hover:bg-light-sky transition cursor-pointer"><input type="checkbox" name="addons[]" value="Interior Wall Wash" class="h-5 w-5 text-fresh-sky"><span class="ml-4 font-medium">Interior Wall Wash</span></label>
                        <label class="form-checkbox-label flex items-center p-4 border border-gray-300 rounded-lg hover:bg-light-sky transition cursor-pointer"><input type="checkbox" name="addons[]" value="Carpet Steam Clean" class="h-5 w-5 text-fresh-sky"><span class="ml-4 font-medium">Carpet Steam Clean</span></label>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" class="prev-step bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                        <button type="button" class="next-step bg-fresh-sky hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg">Next <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                 </div>

                 <div class="form-step" id="step-3">
                    <h3 class="text-2xl font-bold text-deep-navy mb-6">Your Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-slate-700 font-medium mb-2" for="full-name">Full Name</label><input type="text" id="full-name" name="full-name" class="w-full p-3 border border-slate-300 rounded-lg" required placeholder="John Doe" aria-describedby="full-name-error-msg"><p id="full-name-error-msg" class="error-message">Please enter your full name.</p></div>
                        <div><label class="block text-slate-700 font-medium mb-2" for="phone">Phone Number</label><input type="tel" id="phone" name="phone" class="w-full p-3 border border-slate-300 rounded-lg" required placeholder="0412 345 678" aria-describedby="phone-error-msg"><p id="phone-error-msg" class="error-message">Please enter a valid phone number.</p></div>
                        <div class="md:col-span-2"><label class="block text-slate-700 font-medium mb-2" for="email">Email Address</label><input type="email" id="email" name="email" class="w-full p-3 border border-slate-300 rounded-lg" required placeholder="you@email.com" aria-describedby="email-error-msg"><p id="email-error-msg" class="error-message">Please enter a valid email address.</p></div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" class="prev-step bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                        <button type="button" class="next-step bg-fresh-sky hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg">Next <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                 </div>

                 <div class="form-step" id="step-4">
                    <h3 class="text-2xl font-bold text-deep-navy mb-6">Review Your Request</h3>
                    <div class="bg-slate-50 rounded-xl p-6 mb-6 space-y-3">
                        <div class="summary-item flex justify-between items-center"><span class="text-slate-600">Property:</span><span class="font-bold text-right text-deep-navy" id="review-property-summary">-</span></div>
                        <div class="summary-item"><span class="text-slate-600">Services:</span><ul class="font-bold mt-2 list-disc list-inside text-fresh-sky" id="review-services"></ul></div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" class="prev-step bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-extrabold py-3 px-8 rounded-lg">Submit Quote Request</button>
                    </div>
                 </div>
             </form>
         </div>
     </div>
     <div id="success-message" class="hidden text-center py-12 px-4">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 ring-4 ring-white shadow-lg"><i class="fas fa-check-circle text-green-500 text-5xl"></i></div>
        <h2 class="text-3xl font-bold text-deep-navy mb-4">Success! We'll be in touch.</h2>
        <button id="new-quote-btn" class="bg-fresh-sky hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg">Request Another Quote</button>
     </div>
 </div>
</section>

<script>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('quote-form');
    if (!form) return;

    const formArea = document.getElementById('form-area');
    const successMessage = document.getElementById('success-message');
    const formSteps = Array.from(form.querySelectorAll('.form-step'));
    const stepIndicators = Array.from(document.querySelectorAll('.step-indicator .step'));
    const progressBar = document.getElementById('progress');
    const currentStepDisplay = document.getElementById('current-step-display');
    const newQuoteBtn = document.getElementById('new-quote-btn');
    let currentStep = 1;

    const updateUI = () => {
        formSteps.forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
        });
        if(progressBar) progressBar.style.width = `${((currentStep - 1) / (formSteps.length - 1)) * 100}%`;
        if(currentStepDisplay) currentStepDisplay.textContent = currentStep;
        stepIndicators.forEach((indicator, index) => {
            indicator.classList.remove('active', 'completed');
            if (index + 1 < currentStep) indicator.classList.add('completed');
            if (index + 1 === currentStep) indicator.classList.add('active');
        });
        if (currentStep === formSteps.length) updateReviewSection();
    };

    const validateStep = (stepIndex) => {
        let isValid = true;
        const step = formSteps[stepIndex - 1];
        step.querySelectorAll('[required]').forEach(input => {
            const errorMsg = document.getElementById(input.getAttribute('aria-describedby'));
            let inputValid = input.value.trim() !== '';

            if (input.type === 'email') {
                inputValid = /^\S+@\S+\.\S+$/.test(input.value);
            }

            if (!inputValid) {
                isValid = false;
                input.classList.add('invalid');
                if (errorMsg) errorMsg.style.display = 'block';
            } else {
                input.classList.remove('invalid');
                if (errorMsg) errorMsg.style.display = 'none';
            }
        });
        return isValid;
    };

    const updateReviewSection = () => {
        document.getElementById('review-property-summary').textContent = `${form.bedrooms.value} Bed, ${form.bathrooms.value} Bath ${form['property-type'].value}`;
        const servicesList = document.getElementById('review-services');
        servicesList.innerHTML = '<li>Standard Bond Clean</li>';
        form.querySelectorAll('input[name="addons[]"]:checked').forEach(addon => {
            servicesList.insertAdjacentHTML('beforeend', `<li>${addon.value}</li>`);
        });
    };
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validateStep(3)) return;

        const formData = new FormData(form);
        fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData).toString(),
        })
        .then(() => {
            if(formArea) formArea.style.display = 'none';
            if(successMessage) successMessage.style.display = 'block';
        }).catch((error) => alert('Form submission failed. Please try again.'));
    });

    form.addEventListener('click', (e) => {
        if (e.target.closest('.next-step')) {
            if (validateStep(currentStep)) {
                currentStep++;
                updateUI();
            }
        } else if (e.target.closest('.prev-step')) {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        }
    });

    form.querySelectorAll('.form-checkbox-label').forEach(label => {
        label.addEventListener('click', () => {
            const checkbox = label.querySelector('input');
            label.classList.toggle('selected', checkbox.checked);
        });
    });

    if(newQuoteBtn) {
        newQuoteBtn.addEventListener('click', () => {
            form.reset();
            currentStep = 1;
            if(formArea) formArea.style.display = 'block';
            if(successMessage) successMessage.style.display = 'none';
            updateUI();
        });
    }

    updateUI();
  });
</script>